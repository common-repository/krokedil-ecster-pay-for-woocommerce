!function(e){"use strict";var c=!1,o=null,t=!1,r=!1,a=!1,n=!1,s=function(){"ecster"===e("input[name='payment_method']:checked").val()?e("body").addClass("ecster-selected").removeClass("ecster-deselected"):e("body").removeClass("ecster-selected").addClass("ecster-deselected")},i=function(){e("#ecster-pay-ctr").length||e("form.woocommerce-checkout").after('<div id="ecster-pay-ctr"></div>')},d=function(){e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_create_cart",nonce:wc_ecster.wc_ecster_nonce},success:function(s){s.success&&s.data.wc_ecster_cart_key?(o=s.data.wc_ecster_cart_key,i(),"ecster"===e("input[name='payment_method']:checked").val()&&"object"==typeof window.EcsterPay&&e("#ecster-pay-ctr").length&&null!==o&&EcsterPay.start({cartKey:o,shopTermsUrl:wc_ecster.terms,showCart:!1,showPaymentResult:!1,onCheckoutStartInit:function(){e("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutStartSuccess:function(){e("#order_review").unblock(),c=!0},onCheckoutStartFailure:function(c){e("#order_review").unblock()},onCheckoutUpdateInit:function(){e("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},onCheckoutUpdateSuccess:function(){e("#order_review").unblock(),e("#ecster-pay-ctr").unblock()},onCheckoutUpdateFailure:function(){e("#order_review").unblock()},onCustomerAuthenticated:function(e){!1===n&&(t=e.customer,p(e.customer))},onChangedDeliveryMethod:function(e){},onChangedDeliveryAddress:function(e){!1===a&&(r=e,_(e))},onPaymentSuccess:function(e){h(e)},onPaymentFailure:function(){l("failed")},onPaymentDenied:function(e){l("denied")}})):(i(),e("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+s.data.error_message+"</div>"))}})},u=function(){var c=EcsterPay.updateCart(o);e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_update_cart",cart_key:o,nonce:wc_ecster.wc_ecster_nonce},success:function(t){t.success&&t.data.wc_ecster_cart_key?(c(t.data.wc_ecster_cart_key),o=t.data.wc_ecster_cart_key):(i(),e("#ecster-pay-ctr").html('<div class="woocommerce-error" id="wc-ecster-api-error">'+t.data.error_message+"</div>"))}})},l=function(c){e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_fail_local_order",reason:c,nonce:wc_ecster.wc_ecster_nonce}})},m=function(){d()},p=function(c){a=!0,e("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_customer_authenticated",customer_data:c,nonce:wc_ecster.wc_ecster_nonce},success:function(o){var t;if(t=c.countryCode?c.countryCode:"SE",e("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),e("form.checkout #billing_country").val(t),e("form.checkout #billing_postcode").val(c.zip),console.log("Customer authenticated sucess"),console.log(o),"yes"==o.data.mustLogin){e("form.checkout").prepend('<div class="woocommerce-NoticeGroup woocommerce-NoticeGroup-updateOrderReview"><ul class="woocommerce-error" role="alert"><li>'+o.data.mustLoginMessage+"</li></ul></div>");var r=e("form.checkout").offset().top;e("html, body").animate({scrollTop:r},1e3)}else e("body").trigger("update_checkout")},error:function(e){console.log("Customer authenticated error"),console.log(e)},complete:function(){a=!1}})},_=function(c){n=!0,e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_changed_delivery_address",delivery_address:c,nonce:wc_ecster.wc_ecster_nonce},success:function(){var o;o=c.countryCode?c.countryCode:"SE",t?(e("form.checkout #ship-to-different-address-checkbox").prop("checked",!0),e("form.checkout #shipping_country").val(o),e("form.checkout #shipping_postcode").val(c.zip)):(e("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),e("form.checkout #billing_country").val(o),e("form.checkout #billing_postcode").val(c.zip)),e("body").trigger("update_checkout")},complete:function(){n=!1}})},h=function(c){e("#ecster-pay-ctr").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e("#order_review").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{action:"wc_ecster_on_payment_success",payment_data:c,nonce:wc_ecster.wc_ecster_nonce},success:function(){e("#ship-to-different-address-checkbox").prop("checked",!0);var o,t;o=c.customer.countryCode?c.customer.countryCode:"SE",t=c.customer.cellular.indexOf("*")>-1?"0":c.customer.cellular,e("form.checkout #billing_first_name").val(c.customer.firstName),e("form.checkout #billing_last_name").val(c.customer.lastName),e("form.checkout #billing_email").val(c.customer.email),e("form.checkout #billing_country").val(o),e("form.checkout #billing_address_1").val(c.customer.address),e("form.checkout #billing_city").val(c.customer.city),e("form.checkout #billing_postcode").val(c.customer.zip),e("form.checkout #billing_phone").val(t),c.recipient?(e("form.checkout #shipping_first_name").val(c.recipient.firstName),e("form.checkout #shipping_last_name").val(c.recipient.lastName),e("form.checkout #shipping_country").val(c.recipient.countryCode),e("form.checkout #shipping_address_1").val(c.recipient.address),e("form.checkout #shipping_city").val(c.recipient.city),e("form.checkout #shipping_postcode").val(c.recipient.zip)):e("form.checkout #ship-to-different-address-checkbox").prop("checked",!1),e("form.checkout #terms").length>0&&e("form.checkout #terms").prop("checked",!0),e("#place_order").trigger("submit")}})};e(document).ready(function(){s()}),e(document.body).on("change","input[name='payment_method']",function(c){s(),"ecster"===c.target.value&&e("body").trigger("update_checkout")}),e(document.body).on("updated_checkout",function(){if("ecster"===e("input[name='payment_method']:checked").val()){c?u():m(),e("form.woocommerce-checkout .ecster-pay-choose-other").remove(),e("table.woocommerce-checkout-review-order-table").addClass("ecster-pay-cart").detach().appendTo("form.woocommerce-checkout"),e(document.body).trigger("ecster_move_order_review"),e("#order_comments_field").addClass("ecster-pay-order-notes").detach().appendTo("form.woocommerce-checkout");var o=0;e.each(wc_ecster.move_checkout_fields,function(c,t){o++,e(t).addClass("ecster-pay-moved-div-"+o).detach().appendTo("form.woocommerce-checkout")}),e("input[name='payment_method']").length>1&&e('<p><a href="#" class="button">'+wc_ecster.select_another_method_text+"</a></p>").appendTo("form.woocommerce-checkout").addClass("ecster-pay-choose-other")}}),e(document.body).on("click",".ecster-pay-choose-other a",function(c){c.preventDefault(),e(".ecster-pay-cart").detach().prependTo("#order_review"),e(".ecster-pay-order-notes").detach().appendTo(".woocommerce-shipping-fields");var o=0;e.each(wc_ecster.move_checkout_fields,function(c,t){o++,e(".ecster-pay-moved-div-"+o).detach().appendTo(wc_ecster.move_checkout_fields_origin)}),e(".ecster-pay-choose-other").remove(),e("input[name='payment_method']:checked").prop("checked",!1),"ecster"===e("input[name='payment_method']:eq(0)").val()?e("input[name='payment_method']:eq(1)").prop("checked",!0):e("input[name='payment_method']:eq(0)").prop("checked",!0),s()}),e(document.body).on("checkout_error",function(){"ecster"===e("input[name='payment_method']:checked").val()&&e.ajax(wc_ecster.ajaxurl,{type:"POST",dataType:"json",async:!0,data:{cart_key:o,action:"wc_ecster_on_checkout_error",nonce:wc_ecster.wc_ecster_nonce},success:function(e){},error:function(e){},complete:function(e){console.log("ecster checkout error"),console.log(e.responseJSON),window.location.href=e.responseJSON.data.redirect}})})}(jQuery);